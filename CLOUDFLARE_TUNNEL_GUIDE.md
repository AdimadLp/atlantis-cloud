# Cloudflare Tunnel Configuration Guide

This guide explains how to properly configure Cloudflare Tunnel for your Atlantis Cloud infrastructure.

## Overview

Cloudflare Tunnel creates a secure connection between your server and Cloudflare's network without exposing any ports on your firewall. All traffic flows through Cloudflare's encrypted tunnel.

## Configuration Files

### 1. `cloudflared/config.yml` - Main Configuration

The configuration file defines:

- **Tunnel metadata** (tunnel ID, credentials)
- **Connection settings** (logging, metrics)
- **Ingress rules** (hostname â†’ service routing)

#### Key Sections:

```yaml
# Tunnel identification
tunnel: ${CLOUDFLARE_TUNNEL_ID}
credentials-file: /etc/cloudflared/${CLOUDFLARE_TUNNEL_ID}.json

# Logging and monitoring
loglevel: info
metrics: 0.0.0.0:2000
no-autoupdate: true

# Traffic routing rules
ingress:
  - hostname: example.com
    service: http://backend:8080
  - service: http_status:404 # Catch-all (required)
```

### 2. Ingress Rules Order

**CRITICAL**: Ingress rules are processed **top to bottom** - first match wins!

```yaml
ingress:
  # Specific paths first
  - hostname: iot.atlantis-cloud.com
    path: /api/*
    service: http://iot_api:8000

  - hostname: iot.atlantis-cloud.com
    path: /dashboard/*
    service: http://iot_dashboard:3001

  # Default for hostname (no path)
  - hostname: iot.atlantis-cloud.com
    service: http://iot_dashboard:3001

  # Other hostnames
  - hostname: notes.atlantis-cloud.com
    service: http://affine:3000

  # Catch-all MUST be last
  - service: http_status:404
```

## Required Files in `cloudflared/` Directory

Your `./cloudflared/` directory must contain:

1. **`config.yml`** - Main configuration (already created)
2. **`<tunnel-id>.json`** - Tunnel credentials file (generated by Cloudflare)

### Getting Your Tunnel Credentials

1. **Create a tunnel** in Cloudflare dashboard or CLI:

   ```bash
   cloudflared tunnel create atlantis-cloud
   ```

2. **Download credentials** - Cloudflare will generate a JSON file like:

   ```
   12345678-1234-1234-1234-123456789abc.json
   ```

3. **Place the file** in your `./cloudflared/` directory

4. **Update your `.env`** with the tunnel ID:
   ```bash
   CLOUDFLARE_TUNNEL_ID=12345678-1234-1234-1234-123456789abc
   ```

## Environment Variables Required

Add these to your `.env` file:

```bash
# Cloudflare Tunnel
CLOUDFLARE_TUNNEL_TOKEN=your_tunnel_token  # Optional if using credentials file
CLOUDFLARE_TUNNEL_ID=your_tunnel_id        # Required for credentials file method
CLOUDFLARED_VERSION=latest
```

## Configuration Options Explained

### Origin Request Settings

```yaml
originRequest:
  httpHostHeader: your-domain.com # Host header sent to backend
  connectTimeout: 30s # Connection timeout
  tlsTimeout: 10s # TLS handshake timeout
  noTLSVerify: false # Skip TLS verification (use carefully)
  keepAliveTimeout: 1m30s # Keep-alive timeout
  keepAliveConnections: 100 # Max keep-alive connections
```

### Service Types

1. **HTTP Services**:

   ```yaml
   service: http://backend:8080
   ```

2. **HTTPS Services**:

   ```yaml
   service: https://backend:8443
   ```

3. **Static Responses**:
   ```yaml
   service: http_status:404
   service: hello_world
   ```

### Path Matching

```yaml
# Exact path
path: /api

# Wildcard matching
path: /api/*        # Matches /api/anything
path: /api/**       # Matches /api/deep/nested/paths

# Regex patterns (advanced)
path: "^/api/v[0-9]+/"
```

## Security Best Practices

### 1. Network Isolation

- Services only accessible through tunnel
- No direct port exposure
- Separate networks per service group

### 2. Access Control

```yaml
# Add authentication rules in Cloudflare dashboard
# - Zero Trust Access policies
# - IP restrictions
# - Geographic restrictions
```

### 3. TLS Configuration

```yaml
originRequest:
  noTLSVerify: false # Always verify TLS certificates
  caPool: /path/to/ca-certificates.crt # Custom CA if needed
```

## Monitoring and Debugging

### 1. Metrics Endpoint

```yaml
metrics: 0.0.0.0:2000 # Accessible at http://localhost:2000/metrics
```

### 2. Logging Levels

```yaml
loglevel: debug # debug, info, warn, error, fatal
```

### 3. Health Checks

The Docker Compose includes health checks:

```yaml
healthcheck:
  test:
    ["CMD-SHELL", "cloudflared tunnel info ${CLOUDFLARE_TUNNEL_ID} || exit 1"]
```

## Troubleshooting

### Common Issues

1. **Service Not Reachable**

   - Check if backend service is running
   - Verify network connectivity between cloudflared and service
   - Check service hostname resolution

2. **DNS Not Resolving**

   - Verify DNS records in Cloudflare dashboard
   - Check tunnel status: `cloudflared tunnel info <tunnel-id>`

3. **503 Errors**
   - Backend service is down
   - Network connectivity issues
   - Wrong service port in config

### Debug Commands

```bash
# Check tunnel status
docker exec cloudflared_tunnel cloudflared tunnel info

# View tunnel logs
docker logs cloudflared_tunnel -f

# Test connectivity to backend
docker exec cloudflared_tunnel wget -O- http://backend-service:port/health
```

## Advanced Configuration

### Multiple Domains

```yaml
ingress:
  - hostname: app1.example.com
    service: http://app1:3000

  - hostname: app2.example.com
    service: http://app2:4000

  - hostname: "*.api.example.com" # Wildcard subdomain
    service: http://api-gateway:8080
```

### Load Balancing

```yaml
# Use Cloudflare Load Balancer in dashboard
# Configure multiple tunnels for redundancy
```

### Custom Headers

```yaml
originRequest:
  httpHostHeader: internal.service.com
  # Add custom headers via Cloudflare Transform Rules
```

## Migration from Legacy Setup

If migrating from port-based access:

1. **Update DNS** records to point to Cloudflare
2. **Remove port forwarding** rules from firewall
3. **Update internal** service configurations
4. **Test connectivity** through tunnel before removing old setup

## Security Considerations

- **Never expose** tunnel credentials in version control
- **Rotate credentials** regularly
- **Use Access policies** for sensitive services
- **Monitor access logs** in Cloudflare dashboard
- **Implement rate limiting** in Cloudflare

## Performance Optimization

### Connection Tuning

```yaml
# Optimize for your use case
keepAliveTimeout: 1m30s
keepAliveConnections: 100
connectTimeout: 10s
```

### Compression

- Enable compression in Cloudflare dashboard
- Configure appropriate caching rules
- Use Cloudflare's optimization features

## Backup and Recovery

1. **Backup tunnel credentials** file securely
2. **Document tunnel configuration**
3. **Test recovery procedures** regularly
4. **Have multiple tunnels** for redundancy

This configuration provides a secure, scalable foundation for your Atlantis Cloud infrastructure.
